name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.0.1, etc.

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.9.1'
        arch: 'win64_mingw'
        tools: 'tools_mingw1310'
        cache: true
        
    - name: Set up MinGW
      run: |
        echo "$env:IQTA_TOOLS\mingw1310_64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        echo "Adding MinGW to PATH: $env:IQTA_TOOLS\mingw1310_64\bin"
        
    - name: Verify Environment
      run: |
        Write-Host "Qt6_DIR: $env:Qt6_DIR"
        Write-Host "IQTA_TOOLS: $env:IQTA_TOOLS"
        Write-Host "MinGW Path: $env:IQTA_TOOLS\mingw1310_64\bin"
        Write-Host "Checking if MinGW exists..."
        if (Test-Path "$env:IQTA_TOOLS\mingw1310_64\bin\gcc.exe") {
            Write-Host "✓ GCC found"
            & "$env:IQTA_TOOLS\mingw1310_64\bin\gcc.exe" --version
        }
        if (Test-Path "$env:IQTA_TOOLS\mingw1310_64\bin\mingw32-make.exe") {
            Write-Host "✓ mingw32-make found"
        }
        Write-Host "PATH: $env:PATH"
        
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=$env:Qt6_DIR
        
    - name: Build
      run: |
        cd build
        $cores = $env:NUMBER_OF_PROCESSORS
        if (-not $cores) { $cores = "4" }
        Write-Host "Building with $cores parallel jobs..."
        mingw32-make -j $cores
        
    - name: Deploy Windows
      run: |
        # Create deployment directory
        New-Item -ItemType Directory -Force -Path "deploy_windows"
        
        # Copy executable
        Copy-Item "build\bin\StudentManager.exe" "deploy_windows\"
        
        # Copy configuration and data files
        Copy-Item "config.example.ini" "deploy_windows\"
        if (Test-Path "config.ini") {
            Copy-Item "config.ini" "deploy_windows\"
        }
        if (Test-Path "build\bin\universities.json") {
            Copy-Item "build\bin\universities.json" "deploy_windows\"
        }
        if (Test-Path "src\logo.jpg") {
            Copy-Item "src\logo.jpg" "deploy_windows\"
        }
        
        # Run windeployqt
        $windeployqt = "$env:Qt6_DIR\bin\windeployqt.exe"
        & $windeployqt --verbose 2 --dir "deploy_windows" --libdir "deploy_windows" --plugindir "deploy_windows\plugins" --no-translations --no-system-d3d-compiler --no-opengl-sw --no-compiler-runtime "deploy_windows\StudentManager.exe"
        
        # Copy MinGW runtime libraries
        $mingw_bin = "$env:IQTA_TOOLS\mingw1310_64\bin"
        Write-Host "Copying MinGW DLLs from: $mingw_bin"
        Copy-Item "$mingw_bin\libgcc_s_seh-1.dll" "deploy_windows\" -ErrorAction Stop
        Copy-Item "$mingw_bin\libstdc++-6.dll" "deploy_windows\" -ErrorAction Stop
        Copy-Item "$mingw_bin\libwinpthread-1.dll" "deploy_windows\" -ErrorAction Stop
        
        # Create launcher script
        @"
        @echo off
        cd /d "%~dp0"
        start StudentManager.exe
        "@ | Out-File -FilePath "deploy_windows\run.bat" -Encoding ASCII
        
        # Create README
        $version = "${{ github.ref_name }}" -replace '^v',''
        @"
        NEVRETEM-DER MBS - Windows Distribution
        =======================================
        
        Version: $version
        
        This package contains the NEVRETEM-DER MBS application
        with all required Qt libraries for Windows.
        
        To run the application:
        1. Double-click StudentManager.exe
           OR
        2. Double-click run.bat
        
        Configuration:
        - Copy config.example.ini to config.ini
        - Edit config.ini with your Firebase credentials
        
        Updates:
        - The application can check for updates automatically
        - Go to Help -> Check for Updates to get the latest version
        
        System Requirements:
        - Windows 10 or later
        
        For support, contact: FURKAN KARAKETIR +90 551 145 09 68
        "@ | Out-File -FilePath "deploy_windows\README.txt" -Encoding UTF8
        
    - name: Create ZIP archive
      run: |
        Compress-Archive -Path "deploy_windows\*" -DestinationPath "NEVRETEM-DER_MBS_Windows.zip" -Force
        
    - name: Get version from tag
      id: get_version
      run: |
        $version = "${{ github.ref_name }}" -replace '^v',''
        echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: Release ${{ steps.get_version.outputs.VERSION }}
        draft: false
        prerelease: false
        body: |
          ## NEVRETEM-DER MBS v${{ steps.get_version.outputs.VERSION }}
          
          ### Changes
          <!-- Add release notes here -->
          
          ### Installation
          1. Download `NEVRETEM-DER_MBS_Windows.zip`
          2. Extract to a folder
          3. Run `StudentManager.exe`
          
          ### Requirements
          - Windows 10 or later
          
          ### Auto-Update
          Existing users can update automatically via Help → Check for Updates in the application.
        files: |
          NEVRETEM-DER_MBS_Windows.zip
